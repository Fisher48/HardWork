#### –°–æ–≤–º–µ—â–∞–µ–º –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤ –≤–∞—à–µ–º —Ä–∞–±–æ—á–µ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã–π –≤–∞–∂–Ω—ã–π –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π "–∫—É—Å–æ–∫ –∫–æ–¥–∞" - –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∞—Å—Å, –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ –ø—Ä–æ–µ–∫—Ç–µ.
3. –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –∫–æ–¥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∫–ª–∞—Å—Å–∞) –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞:
   –∫–∞–∫ —ç—Ç–æ—Ç –∫–æ–¥ –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –æ–±—â—É—é —Å–∏—Å—Ç–µ–º—É (–ø–æ–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ –¥–∏–∑–∞–π–Ω–∞ —Å–∏—Å—Ç–µ–º—ã).
   –ù–µ –ø–∏—à–∏—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥/–∫–ª–∞—Å—Å –≤–Ω—É—Ç—Ä–∏ - —Å–∞–º –∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∏—á–µ–≥–æ –∑–Ω–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –≤ —Ü–µ–ª–æ–º, 
   –∞ "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –Ω–∏—á–µ–≥–æ –∑–Ω–∞—Ç—å –æ –µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.

4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç—ã 2 –∏ 3 –µ—â—ë 2-3 —Ä–∞–∑–∞ —Å –¥—Ä—É–≥–∏–º –∫–æ–¥–æ–º.

–í —Ä–µ—à–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ (–ø–æ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏) —á–∞—Å—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –∏ –ø–æ–ª–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –Ω–µ–º—É.

–î–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ —è –≤–∑—è–ª –∫–ª–∞—Å—Å ReportService:

#### –ü—Ä–∏–º–µ—Ä - 1 ReportService
```java
/**
 * ReportService - —ç—Ç–æ –∫–ª–∞—Å—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–±–µ–≥–∞—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª—è.
 * –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–µ–≥ –∫–∞–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, —Ç–∞–∫ –∏ –æ–±—â–∏–π –ø—Ä–æ–±–µ–≥ –≤—Å–µ—Ö –∞–≤—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
 * –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–±–µ–≥–∞—Ö.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞—Ö –∏ –¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–µ.
 * –û—Ç—á–µ—Ç - –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—É—â–Ω–æ—Å—Ç—å—é, –ø–æ—ç—Ç–æ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.
 * –≠—Ç–æ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, —Å—Ç—Ä–æ–∏—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞.
 * –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ, –æ–Ω —Å—á–∏—Ç–∞–µ—Ç —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.
 * –°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 * –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–º —Å–µ—Ä–≤–∏—Å–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Ä–∞–∂–µ–Ω—ã –≤ –≥–ª–∞–≤–Ω–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–µ –∏ –¢–µ–ª–µ–≥—Ä–∞–º–º-–±–æ—Ç–µ, –ø–æ—ç—Ç–æ–º—É
 * –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.
 */

@Service
@Slf4j
public class ReportService {

    private final TripRepository tripRepository;
    private final EnterpriseService enterpriseService;
    private final VehicleService vehicleService;

    @Autowired
    public ReportService(TripRepository tripRepository,
                         EnterpriseService enterpriseService, VehicleService vehicleService) {
        this.tripRepository = tripRepository;
        this.enterpriseService = enterpriseService;
        this.vehicleService = vehicleService;
    }

    @Cacheable(value = "mileageReports",
            key = "{#vehicleId, #startDate?.hashCode(), #endDate?.hashCode(), #period}")
    public MileageReportDTO generateMileageReport(Manager manager,
                                                  String vehicleNumber,
                                                  LocalDateTime startDate,
                                                  LocalDateTime endDate, Period period) {
        Optional<Vehicle> vehicle = Optional.ofNullable(vehicleService.findVehicleByNumber(vehicleNumber)
                .orElseThrow(() -> new VehicleNotFoundException("–ú–∞—à–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: " + vehicleNumber)));

        Long vehicleId = vehicle.get().getId();

        if (!vehicleService.isVehicleManagedByManager(vehicleId, manager.getId())) {
            throw new AccessDeniedException("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∞–≤—Ç–æ–º–æ–±–∏–ª—é.");
        }
        log.info("–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –º–∞—à–∏–Ω–µ id={}, –ø–µ—Ä–∏–æ–¥ {}, —Å {} –ø–æ {}", vehicleId, period, startDate, endDate);

        List<Trip> trips = tripRepository.findTripsForVehicleInTimeRange(vehicleId, startDate, endDate);
        log.debug("–ù–∞–π–¥–µ–Ω–æ {} –ø–æ–µ–∑–¥–æ–∫", trips.size());

        Map<String, BigDecimal> mileageData = calculateMileage(trips, startDate, endDate, period);
        return buildReport(VEHICLE_MILEAGE, period, startDate, endDate, mileageData);
    }

    @Cacheable(value = "enterpriseMileageReports",
            key = "{#enterpriseId, #startDate?.hashCode(), #endDate?.hashCode(), #period}")
    public MileageReportDTO generateEnterpriseMileageReport(Manager manager,
                                                            Long enterpriseId,
                                                            LocalDateTime startDate,
                                                            LocalDateTime endDate, Period period) {
        if (!enterpriseService.isEnterpriseManagedByManager(enterpriseId, manager.getId())) {
            throw new AccessDeniedException("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é.");
        }

        log.info("–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é id={}, –ø–µ—Ä–∏–æ–¥ {}, —Å {} –ø–æ {}", enterpriseId, period, startDate, endDate);

        List<Trip> allTrips = tripRepository.findTripsByEnterpriseAndTimeRange(enterpriseId, startDate, endDate);
        Map<String, BigDecimal> mileageData = calculateMileage(allTrips, startDate, endDate, period);

        return buildReport(ENTERPRISE_MILEAGE, period, startDate, endDate, mileageData);
    }

    public MileageReportDTO generateTotalMileageReport(Manager manager,
                                                       LocalDateTime startDate,
                                                       LocalDateTime endDate, Period period) {
        List<Enterprise> enterprises = enterpriseService.findAllForManager(manager.getId());
        List<Trip> trips = tripRepository.findTripsByEnterpriseAndTimeRange(enterprises, startDate, endDate);

        Map<String, BigDecimal> mileageData = calculateMileage(trips, startDate, endDate, period);

        return buildReport(TOTAL_MILEAGE, period, startDate, endDate, mileageData);
    }

    private MileageReportDTO buildReport(ReportType title, Period period, LocalDateTime startDate,
                                  LocalDateTime endDate, Map<String, BigDecimal> results) {
        MileageReportDTO report = new MileageReportDTO();
        report.setReportType(title.getTitle());
        report.setPeriod(period.getTitle());
        report.setStartDate(startDate.format(DateTimeFormatter.ofPattern("yyyy/MM/dd HH:mm")));
        report.setEndDate(endDate.format(DateTimeFormatter.ofPattern("yyyy/MM/dd HH:mm")));
        report.setResults(results);
        return report;
    }

    private Map<String, BigDecimal> calculateMileage(List<Trip> trips, LocalDateTime startDate,
                                                 LocalDateTime endDate, Period period) {
        Map<String, BigDecimal> mileageMap = new HashMap<>();

        for (Trip trip : trips) {
            if (trip.getStartTime().isAfter(startDate) && trip.getEndTime().isBefore(endDate)) {
                String key = switch (period) {
                    case DAY -> trip.getStartTime().toLocalDate().toString();
                    case MONTH -> trip.getStartTime().getYear() + "-" +
                            String.format("%02d", trip.getStartTime().getMonthValue());
                    case YEAR -> String.valueOf(trip.getStartTime().getYear());
                    default -> throw new IllegalArgumentException("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø–µ—Ä–∏–æ–¥: " + period);
                };

                BigDecimal tripMileage = trip.getMileage() != null ? trip.getMileage() : BigDecimal.ZERO;

                mileageMap.merge(key, tripMileage, BigDecimal::add);
            }
        }

        // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ Map<String, BigDecimal>
        return mileageMap.entrySet()
                .stream()
                .sorted(Map.Entry.comparingByKey())
                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, // –û—Å—Ç–∞–≤–ª—è–µ–º –≤ BigDecimal
                        (e1, e2) -> e1, LinkedHashMap::new));
    }

}
```
___

#### –ü—Ä–∏–º–µ—Ä - 2: ReportFlowService
```java
/**
 * ReportFlowService - —ç—Ç–æ –∫–ª–∞—Å—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¢–µ–ª–µ–≥—Ä–∞–º–º-–±–æ—Ç–æ–º.
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∫ state-machine.
 * –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–µ–∂–¥—É TelegramBot (—Å–æ–æ–±—â–µ–Ω–∏—è, callback, –∫–Ω–æ–ø–∫–∏) –∏ ReportService (—á–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ—Ç—á–µ—Ç–æ–≤)
 * –ó–∞–¥–∞—á–∞ –¥–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ - —Å–≤—è–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –≤—ã–∑–æ–≤–æ–º –Ω—É–∂–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –≤ –Ω—É–∂–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ (–æ—Ç—á–µ—Ç–æ–≤).
 * TelegramBot - –ø–æ–ª—É—á–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–ª –≤ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å, –∞ —É–∂–µ ReportFlowService –∑–Ω–∞–µ—Ç –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –¥–∏–∞–ª–æ–≥ –∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ.
 * 
 */

@Service
@Slf4j
@RequiredArgsConstructor
class ReportFlowService {

  private final AuthContextService authService;
  private final ReportSessionService sessionService;
  private final EnterpriseService enterpriseService;
  private final ReportService reportService;
  private final VehicleService vehicleService;

  public void startReportFlow(Long chatId, MessageSender messageSender) {
    sessionService.createSession(chatId);
    showReportTypeSelection(chatId, messageSender);
  }

  public void processTextInput(Long chatId, String text, MessageSender messageSender) {
    ReportRequestContext session = sessionService.getSession(chatId);
    if (session == null) {
      messageSender.sendText(chatId, "–ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /report");
      return;
    }

    try {
      switch (session.getState()) {
        case VEHICLE_WAITING_NUMBER -> handleVehicleNumber(chatId, session, text, messageSender);
        case WAITING_START_DATE -> handleStartDate(chatId, session, text, messageSender);
        case WAITING_END_DATE -> handleEndDate(chatId, session, text, messageSender);
        default -> {
          messageSender.sendText(chatId, "–ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /report");
          sessionService.removeSession(chatId);
        }
      }
    } catch (Exception e) {
      messageSender.sendText(chatId, "‚ùå –û—à–∏–±–∫–∞: " + e.getMessage());
    }
  }

  public void processCallbackInput(Long chatId, String callbackData, MessageSender messageSender) {
    ReportRequestContext session = sessionService.getSession(chatId);
    if (session == null) {
      messageSender.sendText(chatId, "–ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /report");
      return;
    }

    try {
      if (callbackData.startsWith("report_type:")) {
        handleReportType(chatId, session, callbackData, messageSender);
      } else if (callbackData.startsWith("enterprise:")) {
        handleEnterpriseSelection(chatId, session, callbackData, messageSender);
      } else if (callbackData.startsWith("period:")) {
        handlePeriodSelection(chatId, session, callbackData, messageSender);
      }
    } catch (Exception e) {
      messageSender.sendText(chatId, "‚ùå –û—à–∏–±–∫–∞: " + e.getMessage());
    }
  }

  private void showReportTypeSelection(Long chatId, MessageSender messageSender) {
    List<List<InlineKeyboardButton>> buttons = List.of(
            List.of(
                    InlineKeyboardButton.builder()
                            .text("üöó –ü–æ –º–∞—à–∏–Ω–µ")
                            .callbackData("report_type:vehicle")
                            .build(),
                    InlineKeyboardButton.builder()
                            .text("üè¢ –ü–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é")
                            .callbackData("report_type:enterprise")
                            .build(),
                    InlineKeyboardButton.builder()
                            .text("üìä –û–±—â–∏–π –æ—Ç—á–µ—Ç")
                            .callbackData("report_type:total")
                            .build()
            )
    );

    messageSender.sendKeyboard(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞:", buttons);
  }

  private void handleReportType(Long chatId, ReportRequestContext session,
                                String callbackData, MessageSender messageSender) {
    String type = callbackData.substring("report_type:".length());

    switch (type) {
      case "vehicle" -> {
        session.setType(ReportType.VEHICLE_MILEAGE);
        session.setState(VEHICLE_WAITING_NUMBER);
        messageSender.sendText(chatId, "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Å. –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã:");
      }
      case "enterprise" -> {
        session.setType(ReportType.ENTERPRISE_MILEAGE);
        showEnterpriseList(chatId, messageSender);
      }
      case "total" -> {
        session.setType(ReportType.TOTAL_MILEAGE);
        showPeriodSelection(chatId, messageSender);
      }
      default -> throw new IllegalStateException("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤—ã–±–æ—Ä: " + type);
    }
  }

  private void showEnterpriseList(Long chatId, MessageSender messageSender) {
    Manager manager = authService.getCurrentManager(chatId);
    List<Enterprise> enterprises = enterpriseService.findAllForManager(manager.getId());

    List<List<InlineKeyboardButton>> rows = new ArrayList<>();
    for (Enterprise enterprise : enterprises) {
      rows.add(List.of(
              InlineKeyboardButton.builder()
                      .text(enterprise.getName())
                      .callbackData("enterprise:" + enterprise.getId())
                      .build()
      ));
    }

    messageSender.sendKeyboard(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ:", rows);
  }

  private void handleEnterpriseSelection(Long chatId, ReportRequestContext session,
                                         String callbackData, MessageSender messageSender) {
    Long enterpriseId = Long.parseLong(callbackData.substring("enterprise:".length()));
    Enterprise enterprise = enterpriseService.findById(enterpriseId);

    session.setEnterpriseId(enterpriseId);
    session.setEnterpriseName(enterprise.getName());
    session.setState(BotState.PERIOD_SELECTION);
    showPeriodSelection(chatId, messageSender);
  }

  private void showPeriodSelection(Long chatId, MessageSender messageSender) {
    List<List<InlineKeyboardButton>> buttons = List.of(
            List.of(
                    InlineKeyboardButton.builder().text("–î–µ–Ω—å").callbackData("period:day").build(),
                    InlineKeyboardButton.builder().text("–ú–µ—Å—è—Ü").callbackData("period:month").build(),
                    InlineKeyboardButton.builder().text("–ì–æ–¥").callbackData("period:year").build()
            )
    );

    messageSender.sendKeyboard(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:", buttons);
  }

  private void handlePeriodSelection(Long chatId, ReportRequestContext session,
                                     String callbackData, MessageSender messageSender) {
    String periodStr = callbackData.substring("period:".length());
    Period period = Period.valueOf(periodStr.toUpperCase());

    session.setPeriod(period);
    session.setState(WAITING_START_DATE);
    messageSender.sendText(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É (–ì–ì–ì–ì-–ú–ú-–î–î):");
  }

  private void handleVehicleNumber(Long chatId, ReportRequestContext session,
                                   String vehicleNumber, MessageSender messageSender) {
    Vehicle vehicle = vehicleService.findVehicleByNumber(vehicleNumber)
            .orElseThrow(() -> new IllegalArgumentException("–ú–∞—à–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
    session.setVehicleNumber(vehicleNumber);
    session.setState(BotState.PERIOD_SELECTION);
    showPeriodSelection(chatId, messageSender);
  }

  private void handleStartDate(Long chatId, ReportRequestContext session,
                               String dateStr, MessageSender messageSender) {
    LocalDateTime startDate = parseDate(dateStr);
    session.setStartDate(startDate);
    session.setState(BotState.WAITING_END_DATE);
    messageSender.sendText(chatId, "–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É (–ì–ì–ì–ì-–ú–ú-–î–î):");
  }

  private void handleEndDate(Long chatId, ReportRequestContext session,
                             String dateStr, MessageSender messageSender) {
    LocalDateTime endDate = parseDate(dateStr);
    session.setEndDate(endDate);

    generateReport(chatId, session, messageSender);
    sessionService.removeSession(chatId);
  }

  private LocalDateTime parseDate(String input) {
    try {
      return new DateTimeFormatterBuilder()
              .appendPattern("yyyy[-MM[-dd['T'HH[:mm]]]]")
              .parseDefaulting(ChronoField.MONTH_OF_YEAR, 1)
              .parseDefaulting(ChronoField.DAY_OF_MONTH, 1)
              .parseDefaulting(ChronoField.HOUR_OF_DAY, 0)
              .parseDefaulting(ChronoField.MINUTE_OF_HOUR, 0)
              .toFormatter()
              .parse(input, LocalDateTime::from);
    } catch (Exception e) {
      throw new IllegalArgumentException("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: " + input);
    }
  }

  private void generateReport(Long chatId, ReportRequestContext session,
                              MessageSender messageSender) {
    try {
      Manager manager = authService.getCurrentManager(chatId);
      MileageReportDTO report = createReport(manager, session);

      String formatted = formatReport(report);
      messageSender.sendText(chatId, formatted);

    } catch (Exception e) {
      messageSender.sendText(chatId, "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: " + e.getMessage());
      log.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞", e);
    }
  }

  private MileageReportDTO createReport(Manager manager, ReportRequestContext session) {
    return switch (session.getType()) {
      case VEHICLE_MILEAGE -> reportService.generateMileageReport(
              manager, session.getVehicleNumber(),
              session.getStartDate(), session.getEndDate(), session.getPeriod());

      case ENTERPRISE_MILEAGE -> reportService.generateEnterpriseMileageReport(
              manager, session.getEnterpriseId(),
              session.getStartDate(), session.getEndDate(), session.getPeriod());

      case TOTAL_MILEAGE -> reportService.generateTotalMileageReport(
              manager, session.getStartDate(), session.getEndDate(), session.getPeriod());
    };
  }

  private String formatReport(MileageReportDTO report) {
    return String.format("""
                    üìä %s
                    üìÖ –ü–µ—Ä–∏–æ–¥: %s
                    üîÑ –° %s –ø–æ %s
                    
                    %s
                    """,
            report.getReportType(),
            report.getPeriod(),
            report.getStartDate(),
            report.getEndDate(),
            report.getResults().entrySet().stream()
                    .map(e -> "‚Ä¢ " + e.getKey() + ": " + e.getValue() + " –∫–º")
                    .collect(Collectors.joining("\n"))
    );
  }
}
```

___

#### –ü—Ä–∏–º–µ—Ä - 3:
```java

```

